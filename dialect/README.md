# AWS DSQL Hibernate dialect

## Introduction

The AWS DSQL Hibernate dialect provides integration between Hibernate ORM and Amazon Aurora DSQL. This dialect enables
Java applications to leverage Hibernate's powerful object-relational mapping capabilities while taking advantage of
Aurora DSQL's distributed architecture and high availability.

## Prerequisites

- Java 17 or higher
- Hibernate version 6.2 or higher
- A connection to an Amazon Aurora DSQL database
- PostgreSQL JDBC driver version 42.x or higher

## Setup

A dialect for Hibernate DSQL is used in largely the same way as other dialects for other databases. It is added
as a dependency to your Maven or Gradle application:

```
// Maven
<dependency>
    <groupId>software.amazon.dsql.hibernate</groupId>
    <artifactId>aurora-dsql-hibernate-dialect</artifactId>
    <version>1.0.0</version>
    <type>pom</type>
</dependency>

// Gradle
implementation("software.amazon.dsql.hibernate:aurora-dsql-hibernate-dialect:1.0.0")
```

With the AWS-DSQL-Hibernate JAR included in your Java application, the dialect can then be set in a few ways:
- In a Hibernate.properties file: `hibernate.dialect=software.amazon.dsql.hibernate.dialect.AuroraDSQLDialect`
- In persistence.xml: `<property name="hibernate.dialect" value="software.amazon.dsql.hibernate.dialect.AuroraDSQLDialect"/>`
- In Spring application properties: `spring.jpa.properties.hibernate.dialect=software.amazon.dsql.hibernate.dialect.AuroraDSQLDialect`
- Programmatically using `StandardServiceRegistryBuilder`, the configuration API, or in a `SessionFactory`

Hibernate will not automatically detect the DSQL dialect based on metadata, it must be explicitly specified or else
the PostgreSQLDialect will be used instead. With the dependency in place and the property set in Hibernate,
the AuroraDSQLDialect will then automatically be used in DB interactions. Depending on your logging configuration, this
may be verified in logs as connections are created.

See [Hibernate documentation](https://docs.jboss.org/hibernate/orm/6.6/introduction/html_single/Hibernate_Introduction.html#configuration)
for more information on configuring your Hibernate application, including setting the dialect.

### Database Connection

Configure your database connection for DSQL as follows:

```properties
hibernate.connection.url=jdbc:postgresql://<cluster_endpoint>/postgres?sslMode=verify-full
hibernate.connection.username=<username>
hibernate.connection.driver_class=org.postgresql.Driver
```

## Best practices

### Primary key generation

Hibernate supports various ways to generate primary keys for tables, but Hibernate applications using DSQL should
use UUID as keys, generated by the database. **Auto-incrementing integer keys using sequences or serial are not supported
in DSQL.** UUID key generation can be done in your entity definition as follows:

```java
@Id
@Column(name = "id", updatable = false, nullable = false, columnDefinition = "UUID DEFAULT gen_random_uuid()")
private UUID id;
```

### Auto-DDL

Usage of an automatically generated schema with Hibernate is not recommended with DSQL. While it may be useful
for experimental development or testing environments, it should not be used in production. An automatically generated
schema can perform poorly, and can be destructive in unexpected ways.

## Limitations

- **Foreign Keys**: DSQL does not support foreign key constraints. The dialect disables these constraints, but be aware that referential integrity must be maintained at the application level.
- **Sequences**: Sequence objects, SERIAL, and IDENTITY columns are not supported in DSQL, making them unsuitable for primary key generation in Hibernate.
- **Locking**: DSQL uses optimistic locking for all transactions. Attempting to use Hibernate's locking strategies (including Hibernate version-based optimistic locking) will either fail or have no effect.
- **Temporary tables**: Temporary tables are unsupported in DSQL, and so Hibernate may use standard tables instead. These tables may appear with `HT_` or `HTE_` prefixes, and will be managed automatically by Hibernate.

## Contributing

We welcome contributions to improve the AWS DSQL Hibernate dialect. Please follow these steps:

1. Fork the repository
2. Create a feature branch
3. Make your changes
4. Add or update tests as necessary
5. Submit a pull request

Please ensure your code follows the existing style and includes appropriate tests.

## License

This project is licensed under the [Apache License 2.0](LICENSE).
